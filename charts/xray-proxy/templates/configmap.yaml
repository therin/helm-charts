apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "xray-proxy.fullname" . }}-config
  labels:
    {{- include "xray-proxy.labels" . | nindent 4 }}
data:
  config.json: |
    {
      "log": {
        "loglevel": "{{ .Values.xray.logLevel }}"
      },
      {{- if .Values.monitoring.enabled }}
      "api": {
        "tag": "api",
        "services": ["StatsService"]
      },
      "stats": {},
      {{- end }}
      "inbounds": [
        {{- if .Values.xray.socks5.enabled }}
        {
          "tag": "socks5-inbound",
          "listen": "0.0.0.0",
          "port": {{ .Values.xray.socks5.port }},
          "protocol": "socks",
          "settings": {
            "auth": "{{ .Values.xray.socks5.auth }}",
            "udp": {{ .Values.xray.socks5.udp }}
            {{- if and (eq .Values.xray.socks5.auth "password") .Values.xray.socks5.accounts }}
            ,"accounts": [
              {{- range $index, $account := .Values.xray.socks5.accounts }}
              {{- if $index }},{{ end }}
              {
                "user": "{{ $account.user }}",
                "pass": "{{ $account.pass }}"
              }
              {{- end }}
            ]
            {{- end }}
          },
          "sniffing": {
            "enabled": true,
            "destOverride": ["http", "tls"]
          }
        }
        {{- if .Values.xray.reality.enabled }},{{ end }}
        {{- end }}
        {{- if .Values.xray.reality.enabled }}
        {
          "tag": "vless-reality-inbound",
          "listen": "0.0.0.0",
          "port": {{ .Values.xray.reality.port }},
          "protocol": "vless",
          "settings": {
            "clients": [
              {{- range $index, $client := .Values.xray.reality.clients }}
              {{- if $index }},{{ end }}
              {
                "id": "{{ $client.id }}",
                "flow": "{{ $client.flow | default "xtls-rprx-vision" }}"
              }
              {{- end }}
            ],
            "decryption": "none"
          },
          "streamSettings": {
            "network": "tcp",
            "security": "reality",
            "realitySettings": {
              "show": false,
              "dest": "{{ .Values.xray.reality.dest }}",
              "xver": 0,
              "serverNames": [
                {{- range $index, $name := .Values.xray.reality.serverNames }}
                {{- if $index }},{{ end }}
                "{{ $name }}"
                {{- end }}
              ],
              "privateKey": "{{ .Values.xray.reality.privateKey }}",
              "shortIds": [
                {{- range $index, $id := .Values.xray.reality.shortIds }}
                {{- if $index }},{{ end }}
                "{{ $id }}"
                {{- end }}
              ]
            }
          },
          "sniffing": {
            "enabled": true,
            "destOverride": ["http", "tls"]
          }
        }
        {{- end }}
        {{- if .Values.monitoring.enabled }}
        ,{
          "tag": "api-inbound",
          "listen": "127.0.0.1",
          "port": {{ .Values.monitoring.port }},
          "protocol": "dokodemo-door",
          "settings": {
            "address": "127.0.0.1"
          }
        }
        {{- end }}
      ],
      "outbounds": [
        {
          "tag": "direct",
          "protocol": "freedom"
        },
        {
          "tag": "blocked",
          "protocol": "blackhole"
        }
      ]
      {{- if .Values.xray.routing.enabled }}
      ,"routing": {
        "rules": [
          {{- range $index, $rule := .Values.xray.routing.rules }}
          {{- if $index }},{{ end }}
          {
            "type": "{{ $rule.type }}",
            {{- if $rule.ip }}
            "ip": [
              {{- range $ipIndex, $ip := $rule.ip }}
              {{- if $ipIndex }},{{ end }}
              "{{ $ip }}"
              {{- end }}
            ],
            {{- end }}
            {{- if $rule.network }}
            "network": "{{ $rule.network }}",
            {{- end }}
            "outboundTag": "{{ $rule.outboundTag }}"
          }
          {{- end }}
        ]
      }
      {{- end }}
    }