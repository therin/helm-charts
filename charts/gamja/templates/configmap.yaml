---
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ .Chart.Name }}
  labels:
    app: {{ .Chart.Name }}
data:
  config.json: |
    {
      "server": {
        "url": {{ .Values.config.server.url | quote }},
        "autoconnect": {{ .Values.config.server.autoconnect }},
        "auth": {{ .Values.config.server.auth | quote }}
      }
      {{- if .Values.config.nick }},
      "nick": {{ .Values.config.nick | quote }}
      {{- end }}
      {{- if .Values.config.autojoin }},
      "autojoin": {{ .Values.config.autojoin | quote }}
      {{- end }}
    }
  nginx.conf: |
    resolver kube-dns.kube-system.svc.buran-kube.local valid=10s;

    server {
        listen 8080;
        server_name _;

        # Serve gamja static files (gamja runs on port 80 in same pod)
        location / {
            proxy_pass http://127.0.0.1:80;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }

        # Proxy websocket to soju (use variable for dynamic resolution)
        location /socket {
            set $soju_backend "{{ .Values.soju.service }}:{{ .Values.soju.websocketPort }}";
            proxy_pass http://$soju_backend;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_read_timeout 86400;
        }
    }
